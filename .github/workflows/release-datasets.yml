name: Release Datasets

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag (e.g. 2026-02). Defaults to dataset-YYYY-MM-DD.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghcrunner
          df -h /

      - name: Checkout with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Verify LFS files were downloaded
        run: |
          total=$(find . -name "*.parquet" -type f | wc -l)
          pointers=0
          while IFS= read -r f; do
            if head -1 "$f" 2>/dev/null | grep -q "^version https://git-lfs"; then
              pointers=$((pointers + 1))
            fi
          done < <(find . -name "*.parquet" -type f)

          echo "Parquet files: $total (LFS pointers remaining: $pointers)"

          if [ "$pointers" -gt 0 ]; then
            echo "Retrying LFS pull..."
            git lfs pull

            pointers=0
            while IFS= read -r f; do
              if head -1 "$f" 2>/dev/null | grep -q "^version https://git-lfs"; then
                pointers=$((pointers + 1))
              fi
            done < <(find . -name "*.parquet" -type f)

            if [ "$pointers" -gt 0 ]; then
              echo "::error::$pointers LFS files could not be downloaded"
              exit 1
            fi
          fi

          echo "All LFS files downloaded successfully."

      - name: Package datasets by region
        id: package
        run: |
          mkdir -p release-assets

          REGIONS=("nacional" "ted" "catalunya" "valencia" "ccaa_Andalucia" "comunidad_madrid")
          SUMMARY=""

          for region in "${REGIONS[@]}"; do
            if [ ! -d "$region" ]; then
              continue
            fi

            mapfile -t files < <(find "$region" -name "*.parquet" -type f)
            count=${#files[@]}

            if [ "$count" -eq 0 ]; then
              continue
            fi

            echo "Packaging $region ($count parquet files)..."
            # -0: store without compression (parquet is already compressed internally)
            printf '%s\n' "${files[@]}" | zip -0 "release-assets/${region}.zip" -@
            size=$(du -h "release-assets/${region}.zip" | cut -f1)
            echo "  -> ${region}.zip: $size ($count files)"
            SUMMARY="${SUMMARY}| \`${region}.zip\` | ${size} | ${count} |\n"
          done

          echo ""
          echo "=== Release assets ==="
          ls -lh release-assets/

          # Pass summary to next step
          echo "summary<<EOFSUM" >> "$GITHUB_OUTPUT"
          echo -e "$SUMMARY" >> "$GITHUB_OUTPUT"
          echo "EOFSUM" >> "$GITHUB_OUTPUT"

      - name: Determine tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag_name }}" ]; then
            TAG="${{ inputs.tag_name }}"
          else
            TAG="dataset-$(date +%Y-%m-%d)"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "title=Datasets $TAG" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        run: |
          cat > release-notes.md <<'EOF'
          ## Datasets de Licitaciones de España

          Archivos parquet empaquetados por región, descargables directamente **sin necesidad de Git LFS**.

          ### Contenido

          | Archivo | Tamaño | Archivos parquet |
          |---------|--------|------------------|
          EOF

          echo '${{ steps.package.outputs.summary }}' >> release-notes.md

          cat >> release-notes.md <<'EOF'

          ### Uso

          1. Descarga el zip de la región que necesites
          2. Descomprime el archivo
          3. Lee los parquet con pandas:

          ```python
          import pandas as pd
          df = pd.read_parquet("nombre_archivo.parquet")
          ```

          > Generado automáticamente desde GitHub Actions.
          EOF

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          TITLE="${{ steps.tag.outputs.title }}"

          # Create tag (fail gracefully if it already exists)
          git tag "$TAG" 2>/dev/null || true
          git push origin "$TAG" 2>/dev/null || true

          # Create release with all zip assets
          gh release create "$TAG" \
            --title "$TITLE" \
            --notes-file release-notes.md \
            --latest \
            release-assets/*.zip
