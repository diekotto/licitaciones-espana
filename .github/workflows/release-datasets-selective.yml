name: Release Datasets (Selective)

on:
  workflow_dispatch:
    inputs:
      regions:
        description: 'Comma-separated regions (empty = all). Options: nacional,ted,catalunya,valencia,ccaa_Andalucia,comunidad_madrid'
        required: false
        type: string
        default: ''
      tag_name:
        description: 'Release tag (e.g. 2026-02). Defaults to dataset-YYYY-MM-DD.'
        required: false
        type: string
      skip_packaging:
        description: 'Only test LFS checkout (skip packaging and release)'
        required: false
        type: boolean
        default: false
      skip_release:
        description: 'Package but do not create a release'
        required: false
        type: boolean
        default: false
      draft_release:
        description: 'Create release as draft (not public)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (lightweight, no LFS)
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Resolve regions
        id: regions
        run: |
          if [ -z "${{ inputs.regions }}" ]; then
            echo "list=nacional,ted,catalunya,valencia,ccaa_Andalucia,comunidad_madrid" >> "$GITHUB_OUTPUT"
          else
            echo "list=${{ inputs.regions }}" >> "$GITHUB_OUTPUT"
          fi
          echo "Selected regions: $(cat "$GITHUB_OUTPUT" | grep list | cut -d= -f2)"

      - name: Prepare workspace
        id: workspace
        uses: ./.github/actions/prepare-workspace
        with:
          free-disk-space: 'true'

      # --- Package each region (guarded) ---
      - name: Package nacional
        id: pkg-nacional
        if: ${{ !inputs.skip_packaging && contains(steps.regions.outputs.list, 'nacional') }}
        uses: ./.github/actions/package-region
        with:
          region: nacional

      - name: Package ted
        id: pkg-ted
        if: ${{ !inputs.skip_packaging && contains(steps.regions.outputs.list, 'ted') }}
        uses: ./.github/actions/package-region
        with:
          region: ted

      - name: Package catalunya
        id: pkg-catalunya
        if: ${{ !inputs.skip_packaging && contains(steps.regions.outputs.list, 'catalunya') }}
        uses: ./.github/actions/package-region
        with:
          region: catalunya

      - name: Package valencia
        id: pkg-valencia
        if: ${{ !inputs.skip_packaging && contains(steps.regions.outputs.list, 'valencia') }}
        uses: ./.github/actions/package-region
        with:
          region: valencia

      - name: Package ccaa_Andalucia
        id: pkg-andalucia
        if: ${{ !inputs.skip_packaging && contains(steps.regions.outputs.list, 'ccaa_Andalucia') }}
        uses: ./.github/actions/package-region
        with:
          region: ccaa_Andalucia

      - name: Package comunidad_madrid
        id: pkg-madrid
        if: ${{ !inputs.skip_packaging && contains(steps.regions.outputs.list, 'comunidad_madrid') }}
        uses: ./.github/actions/package-region
        with:
          region: comunidad_madrid

      # --- Build summary table ---
      - name: Build summary
        id: summary
        if: ${{ !inputs.skip_packaging }}
        run: |
          SUMMARY=""
          add_row() {
            local name="$1" size="$2" count="$3" skipped="$4"
            if [ "$skipped" != "true" ] && [ "$count" -gt 0 ] 2>/dev/null; then
              SUMMARY="${SUMMARY}| \`${name}.zip\` | ${size} | ${count} |\n"
            fi
          }

          add_row "nacional"         "${{ steps.pkg-nacional.outputs.zip-size }}"   "${{ steps.pkg-nacional.outputs.file-count }}"   "${{ steps.pkg-nacional.outputs.skipped }}"
          add_row "ted"              "${{ steps.pkg-ted.outputs.zip-size }}"         "${{ steps.pkg-ted.outputs.file-count }}"         "${{ steps.pkg-ted.outputs.skipped }}"
          add_row "catalunya"        "${{ steps.pkg-catalunya.outputs.zip-size }}"   "${{ steps.pkg-catalunya.outputs.file-count }}"   "${{ steps.pkg-catalunya.outputs.skipped }}"
          add_row "valencia"         "${{ steps.pkg-valencia.outputs.zip-size }}"    "${{ steps.pkg-valencia.outputs.file-count }}"    "${{ steps.pkg-valencia.outputs.skipped }}"
          add_row "ccaa_Andalucia"   "${{ steps.pkg-andalucia.outputs.zip-size }}"   "${{ steps.pkg-andalucia.outputs.file-count }}"   "${{ steps.pkg-andalucia.outputs.skipped }}"
          add_row "comunidad_madrid" "${{ steps.pkg-madrid.outputs.zip-size }}"      "${{ steps.pkg-madrid.outputs.file-count }}"      "${{ steps.pkg-madrid.outputs.skipped }}"

          echo "table<<EOFSUM" >> "$GITHUB_OUTPUT"
          echo -e "$SUMMARY" >> "$GITHUB_OUTPUT"
          echo "EOFSUM" >> "$GITHUB_OUTPUT"

          echo "=== Release assets ==="
          ls -lh release-assets/ 2>/dev/null || echo "(no assets)"

      # --- Create release (guarded) ---
      - name: Create release
        if: ${{ !inputs.skip_packaging && !inputs.skip_release }}
        uses: ./.github/actions/create-release
        with:
          tag-name: ${{ inputs.tag_name }}
          summary-table: ${{ steps.summary.outputs.table }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          draft: ${{ inputs.draft_release && 'true' || 'false' }}
